name: Security Scanning

on:
  schedule:
    # Run comprehensive security scans daily at 2 AM UTC
    - cron: "0 2 * * *"
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "scripts/**"
      - "requirements.txt"
      - "Dockerfile*"
      - "docker/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "scripts/**"
      - "requirements.txt"
      - "Dockerfile*"
      - "docker/**"
  workflow_dispatch:
    inputs:
      scan_type:
        description: "Type of security scan"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - code
          - dependencies
          - containers
          - infrastructure
      severity_threshold:
        description: "Minimum severity level for build blocking"
        required: false
        default: "high"
        type: choice
        options:
          - low
          - medium
          - high
          - critical
      fail_on_high:
        description: "Fail build on high+ severity vulnerabilities"
        required: false
        default: true
        type: boolean
      create_issues:
        description: "Create GitHub issues for critical vulnerabilities"
        required: false
        default: true
        type: boolean
      scan_all_images:
        description: "Scan all available Docker images"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  SECURITY_REPORT_DIR: security_reports
  PYTHON_VERSION: "3.10"

jobs:
  # Job 1: Security Scan Configuration and Setup
  security-setup:
    name: Security Scan Setup
    runs-on: ubuntu-latest
    outputs:
      scan_code: ${{ steps.config.outputs.scan_code }}
      scan_dependencies: ${{ steps.config.outputs.scan_dependencies }}
      scan_containers: ${{ steps.config.outputs.scan_containers }}
      scan_infrastructure: ${{ steps.config.outputs.scan_infrastructure }}
      severity_threshold: ${{ steps.config.outputs.severity_threshold }}
      fail_on_high: ${{ steps.config.outputs.fail_on_high }}
      create_issues: ${{ steps.config.outputs.create_issues }}
      scan_timestamp: ${{ steps.config.outputs.scan_timestamp }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure scan parameters
        id: config
        run: |
          # Determine what to scan based on input or trigger
          SCAN_TYPE="${{ inputs.scan_type || 'all' }}"

          if [ "$SCAN_TYPE" = "all" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "scan_code=true" >> $GITHUB_OUTPUT
            echo "scan_dependencies=true" >> $GITHUB_OUTPUT
            echo "scan_containers=true" >> $GITHUB_OUTPUT
            echo "scan_infrastructure=true" >> $GITHUB_OUTPUT
          else
            echo "scan_code=$([[ '$SCAN_TYPE' == 'code' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "scan_dependencies=$([[ '$SCAN_TYPE' == 'dependencies' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "scan_containers=$([[ '$SCAN_TYPE' == 'containers' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "scan_infrastructure=$([[ '$SCAN_TYPE' == 'infrastructure' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          fi

          # Set other parameters
          echo "severity_threshold=${{ inputs.severity_threshold || 'high' }}" >> $GITHUB_OUTPUT
          echo "fail_on_high=${{ inputs.fail_on_high || 'true' }}" >> $GITHUB_OUTPUT
          echo "create_issues=${{ inputs.create_issues || 'true' }}" >> $GITHUB_OUTPUT
          echo "scan_timestamp=$(date -u +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Create security reports directory
        run: |
          mkdir -p ${{ env.SECURITY_REPORT_DIR }}
          echo "Security scan initiated at $(date -u)" > ${{ env.SECURITY_REPORT_DIR }}/scan_info.txt
          echo "Trigger: ${{ github.event_name }}" >> ${{ env.SECURITY_REPORT_DIR }}/scan_info.txt
          echo "Repository: ${{ github.repository }}" >> ${{ env.SECURITY_REPORT_DIR }}/scan_info.txt
          echo "Commit: ${{ github.sha }}" >> ${{ env.SECURITY_REPORT_DIR }}/scan_info.txt

      - name: Upload scan configuration
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-config
          path: ${{ env.SECURITY_REPORT_DIR }}/scan_info.txt

  # Job 2: Advanced Code Security Analysis
  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    needs: [security-setup]
    if: needs.security-setup.outputs.scan_code == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache security tools
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-security-tools-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-security-tools-

      - name: Install enhanced security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] semgrep safety pip-audit cyclonedx-bom

          # Install additional security scanners
          pip install vulture  # Dead code detection
          pip install dlint    # Django security linting
          pip install pyre-check || echo "Pyre-check installation failed, continuing..."

      - name: Run comprehensive Bandit security scan
        run: |
          echo "üîç Running Bandit security analysis..."

          # Create Bandit configuration
          cat > .bandit << 'EOF'
          [bandit]
          exclude_dirs = ["/tests", "/venv", "/.venv", "/env", "/.env"]
          skips = ["B101", "B601"]  # Skip assert_used_in_tests and shell_injection_process_args

          [bandit.blacklist_calls]
          bad_name_sets = [
              "pickle",
              "marshal",
              "shelve",
              "subprocess_popen",
              "subprocess_call"
          ]
          EOF

          # Run Bandit with multiple output formats
          bandit -r src/ scripts/ -f json -o ${{ env.SECURITY_REPORT_DIR }}/bandit-report.json -ll
          bandit -r src/ scripts/ -f txt -o ${{ env.SECURITY_REPORT_DIR }}/bandit-report.txt -ll
          bandit -r src/ scripts/ -f csv -o ${{ env.SECURITY_REPORT_DIR }}/bandit-report.csv -ll
          bandit -r src/ scripts/ -f html -o ${{ env.SECURITY_REPORT_DIR }}/bandit-report.html -ll

          # Generate summary
          echo "## Bandit Security Scan Results" > ${{ env.SECURITY_REPORT_DIR }}/bandit-summary.md
          echo "**Scan Date:** $(date -u)" >> ${{ env.SECURITY_REPORT_DIR }}/bandit-summary.md
          echo "**Files Scanned:** $(find src/ scripts/ -name '*.py' | wc -l)" >> ${{ env.SECURITY_REPORT_DIR }}/bandit-summary.md

          # Extract issue counts
          if [ -f ${{ env.SECURITY_REPORT_DIR }}/bandit-report.json ]; then
            python3 -c "
            import json
            with open('${{ env.SECURITY_REPORT_DIR }}/bandit-report.json', 'r') as f:
                data = json.load(f)

            metrics = data.get('metrics', {})
            print(f'**Lines of Code:** {metrics.get(\"_totals\", {}).get(\"loc\", \"Unknown\")}')
            print(f'**Issues Found:** {len(data.get(\"results\", []))}')

            # Count by severity
            severity_counts = {}
            for result in data.get('results', []):
                severity = result.get('issue_severity', 'UNKNOWN')
                severity_counts[severity] = severity_counts.get(severity, 0) + 1

            for severity, count in severity_counts.items():
                print(f'**{severity}:** {count}')
            " >> ${{ env.SECURITY_REPORT_DIR }}/bandit-summary.md
          fi
        continue-on-error: true

      - name: Run advanced Semgrep security scan
        run: |
          echo "üîç Running Semgrep security analysis..."

          # Run Semgrep with multiple rulesets
          semgrep --config=auto --json --output=${{ env.SECURITY_REPORT_DIR }}/semgrep-auto.json src/ scripts/ || true
          semgrep --config=p/security-audit --json --output=${{ env.SECURITY_REPORT_DIR }}/semgrep-security.json src/ scripts/ || true
          semgrep --config=p/python --json --output=${{ env.SECURITY_REPORT_DIR }}/semgrep-python.json src/ scripts/ || true
          semgrep --config=p/owasp-top-ten --json --output=${{ env.SECURITY_REPORT_DIR }}/semgrep-owasp.json src/ scripts/ || true

          # Generate combined report
          semgrep --config=auto --config=p/security-audit --config=p/python \
            --json --output=${{ env.SECURITY_REPORT_DIR }}/semgrep-combined.json src/ scripts/ || true

          # Generate text report for review
          semgrep --config=auto --config=p/security-audit --config=p/python \
            --output=${{ env.SECURITY_REPORT_DIR }}/semgrep-report.txt src/ scripts/ || true

          # Generate SARIF format for GitHub integration
          semgrep --config=auto --sarif --output=${{ env.SECURITY_REPORT_DIR }}/semgrep-results.sarif src/ scripts/ || true
        continue-on-error: true

      - name: Run secret detection with enhanced patterns
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head: HEAD
          extra_args: >-
            --debug
            --only-verified
            --json
            --output=${{ env.SECURITY_REPORT_DIR }}/trufflehog-secrets.json

      - name: Run dead code analysis
        run: |
          echo "üîç Running dead code analysis..."
          vulture src/ scripts/ --json > ${{ env.SECURITY_REPORT_DIR }}/vulture-deadcode.json || true
          vulture src/ scripts/ > ${{ env.SECURITY_REPORT_DIR }}/vulture-deadcode.txt || true
        continue-on-error: true

      - name: Generate code security summary
        run: |
          echo "# Code Security Analysis Summary" > ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "**Scan Date:** $(date -u)" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md

          echo "## Tools Used" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "- ‚úÖ Bandit (Python security linter)" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "- ‚úÖ Semgrep (Multi-language static analysis)" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "- ‚úÖ TruffleHog (Secret detection)" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "- ‚úÖ Vulture (Dead code detection)" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          echo "" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md

          echo "## Report Files Generated" >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md
          ls -la ${{ env.SECURITY_REPORT_DIR }}/ | grep -E '\.(json|txt|html|csv|sarif|md)$' >> ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md

      - name: Upload SARIF results to GitHub Security
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: ${{ env.SECURITY_REPORT_DIR }}/semgrep-results.sarif
        continue-on-error: true

      - name: Upload code security reports
        uses: actions/upload-artifact@v4
        with:
          name: code-security-reports
          path: |
            ${{ env.SECURITY_REPORT_DIR }}/bandit-*
            ${{ env.SECURITY_REPORT_DIR }}/semgrep-*
            ${{ env.SECURITY_REPORT_DIR }}/trufflehog-*
            ${{ env.SECURITY_REPORT_DIR }}/vulture-*
            ${{ env.SECURITY_REPORT_DIR }}/code-security-summary.md

  # Job 3: Comprehensive Dependency Security Analysis
  dependency-security:
    name: Dependency Security Analysis
    runs-on: ubuntu-latest
    needs: [security-setup]
    if: needs.security-setup.outputs.scan_dependencies == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache dependency tools
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-dependency-tools-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-dependency-tools-

      - name: Install comprehensive dependency analysis tools
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit cyclonedx-bom pipdeptree pip-licenses
          pip install osv-scanner || echo "OSV scanner installation failed, continuing..."

          # Install project dependencies for analysis
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Generate dependency tree and licenses
        run: |
          echo "üì¶ Generating dependency analysis..."

          # Ensure security reports directory exists
          mkdir -p ${{ env.SECURITY_REPORT_DIR }}

          # Generate dependency tree
          pipdeptree --json > ${{ env.SECURITY_REPORT_DIR }}/dependency-tree.json
          pipdeptree > ${{ env.SECURITY_REPORT_DIR }}/dependency-tree.txt

          # Generate license report
          pip-licenses --format=json --output-file=${{ env.SECURITY_REPORT_DIR }}/licenses.json
          pip-licenses --format=markdown --output-file=${{ env.SECURITY_REPORT_DIR }}/licenses.md
          pip-licenses > ${{ env.SECURITY_REPORT_DIR }}/licenses.txt

          # Generate SBOM (Software Bill of Materials)
          cyclonedx-py -o ${{ env.SECURITY_REPORT_DIR }}/sbom.json
          cyclonedx-py -o ${{ env.SECURITY_REPORT_DIR }}/sbom.xml --format xml

      - name: Run enhanced Safety vulnerability check
        run: |
          echo "üîç Running Safety vulnerability analysis..."

          # Run Safety with multiple output formats
          safety check --json --output ${{ env.SECURITY_REPORT_DIR }}/safety-report.json || true
          safety check --output ${{ env.SECURITY_REPORT_DIR }}/safety-report.txt || true

          # Run Safety with full report including ignored vulnerabilities
          safety check --full-report --json --output ${{ env.SECURITY_REPORT_DIR }}/safety-full-report.json || true
          safety check --full-report --output ${{ env.SECURITY_REPORT_DIR }}/safety-full-report.txt || true

          # Generate Safety policy file for future use
          cat > ${{ env.SECURITY_REPORT_DIR }}/safety-policy.json << 'EOF'
          {
            "security": {
              "ignore-cvss-severity-below": 0.0,
              "ignore-cvss-unknown-severity": false,
              "ignore-vulnerabilities": [],
              "continue-on-vulnerability-error": false
            }
          }
          EOF
        continue-on-error: true

      - name: Run pip-audit vulnerability scanning
        run: |
          echo "üîç Running pip-audit vulnerability analysis..."

          # Run pip-audit with multiple formats
          pip-audit --format=json --output=${{ env.SECURITY_REPORT_DIR }}/pip-audit-report.json || true
          pip-audit --format=cyclonedx-json --output=${{ env.SECURITY_REPORT_DIR }}/pip-audit-sbom.json || true
          pip-audit --output=${{ env.SECURITY_REPORT_DIR }}/pip-audit-report.txt || true

          # Run pip-audit with requirements file analysis
          if [ -f requirements.txt ]; then
            pip-audit --requirement requirements.txt --format=json --output=${{ env.SECURITY_REPORT_DIR }}/pip-audit-requirements.json || true
            pip-audit --requirement requirements.txt --output=${{ env.SECURITY_REPORT_DIR }}/pip-audit-requirements.txt || true
          fi
        continue-on-error: true

      - name: Run OSV vulnerability scanning
        run: |
          echo "üîç Running OSV vulnerability analysis..."

          # Install OSV scanner if not available via pip
          if ! command -v osv-scanner &> /dev/null; then
            curl -L https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o osv-scanner
            chmod +x osv-scanner
            sudo mv osv-scanner /usr/local/bin/
          fi

          # Run OSV scanner on the repository
          osv-scanner --format json --output ${{ env.SECURITY_REPORT_DIR }}/osv-report.json . || true
          osv-scanner --output ${{ env.SECURITY_REPORT_DIR }}/osv-report.txt . || true

          # Run OSV scanner specifically on requirements.txt
          if [ -f requirements.txt ]; then
            osv-scanner --format json --output ${{ env.SECURITY_REPORT_DIR }}/osv-requirements.json requirements.txt || true
          fi
        continue-on-error: true

      - name: Analyze dependency security posture
        run: |
          echo "üìä Analyzing dependency security posture..."

          python3 << 'EOF'
          import json
          import os
          from pathlib import Path

          report_dir = Path("${{ env.SECURITY_REPORT_DIR }}")

          # Initialize counters
          total_vulnerabilities = 0
          severity_counts = {"critical": 0, "high": 0, "medium": 0, "low": 0, "unknown": 0}
          vulnerable_packages = set()

          # Analyze Safety report
          safety_file = report_dir / "safety-report.json"
          if safety_file.exists():
              try:
                  with open(safety_file) as f:
                      safety_data = json.load(f)

                  for vuln in safety_data:
                      total_vulnerabilities += 1
                      package_name = vuln.get("package_name", "unknown")
                      vulnerable_packages.add(package_name)

                      # Safety doesn't provide severity, assume medium
                      severity_counts["medium"] += 1
              except Exception as e:
                  print(f"Error processing Safety report: {e}")

          # Analyze pip-audit report
          pip_audit_file = report_dir / "pip-audit-report.json"
          if pip_audit_file.exists():
              try:
                  with open(pip_audit_file) as f:
                      pip_audit_data = json.load(f)

                  for vuln in pip_audit_data.get("vulnerabilities", []):
                      total_vulnerabilities += 1
                      package_name = vuln.get("package", {}).get("name", "unknown")
                      vulnerable_packages.add(package_name)

                      # pip-audit doesn't provide severity, assume medium
                      severity_counts["medium"] += 1
              except Exception as e:
                  print(f"Error processing pip-audit report: {e}")

          # Generate summary
          summary = {
              "total_vulnerabilities": total_vulnerabilities,
              "severity_breakdown": severity_counts,
              "vulnerable_packages_count": len(vulnerable_packages),
              "vulnerable_packages": list(vulnerable_packages)
          }

          # Save summary
          with open(report_dir / "dependency-security-summary.json", "w") as f:
              json.dump(summary, f, indent=2)

          # Generate markdown summary
          with open(report_dir / "dependency-security-summary.md", "w") as f:
              f.write("# Dependency Security Analysis Summary\n\n")
              f.write(f"**Total Vulnerabilities:** {total_vulnerabilities}\n")
              f.write(f"**Vulnerable Packages:** {len(vulnerable_packages)}\n\n")

              if vulnerable_packages:
                  f.write("## Vulnerable Packages\n")
                  for pkg in sorted(vulnerable_packages):
                      f.write(f"- {pkg}\n")

              f.write(f"\n## Severity Breakdown\n")
              for severity, count in severity_counts.items():
                  if count > 0:
                      f.write(f"- **{severity.upper()}:** {count}\n")

          print(f"Dependency analysis complete: {total_vulnerabilities} vulnerabilities found in {len(vulnerable_packages)} packages")
          EOF

      - name: Check dependency security thresholds
        id: dependency_check
        run: |
          echo "üö® Checking dependency security thresholds..."

          THRESHOLD="${{ needs.security-setup.outputs.severity_threshold }}"
          FAIL_ON_HIGH="${{ needs.security-setup.outputs.fail_on_high }}"

          # Count vulnerabilities from summary
          if [ -f ${{ env.SECURITY_REPORT_DIR }}/dependency-security-summary.json ]; then
            TOTAL_VULNS=$(python3 -c "
            import json
            with open('${{ env.SECURITY_REPORT_DIR }}/dependency-security-summary.json') as f:
                data = json.load(f)
            print(data['total_vulnerabilities'])
            ")

            echo "dependency_vulnerabilities=$TOTAL_VULNS" >> $GITHUB_OUTPUT

            if [ "$FAIL_ON_HIGH" = "true" ] && [ "$TOTAL_VULNS" -gt 0 ]; then
              echo "dependency_threshold_exceeded=true" >> $GITHUB_OUTPUT
              echo "‚ùå Dependency vulnerabilities found: $TOTAL_VULNS"
            else
              echo "dependency_threshold_exceeded=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Dependency security check passed"
            fi
          else
            echo "dependency_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "dependency_threshold_exceeded=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload dependency security reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-reports
          path: |
            ${{ env.SECURITY_REPORT_DIR }}/dependency-*
            ${{ env.SECURITY_REPORT_DIR }}/safety-*
            ${{ env.SECURITY_REPORT_DIR }}/pip-audit-*
            ${{ env.SECURITY_REPORT_DIR }}/osv-*
            ${{ env.SECURITY_REPORT_DIR }}/licenses.*
            ${{ env.SECURITY_REPORT_DIR }}/sbom.*

  # Job 4: Advanced Container Security Analysis
  container-security:
    name: Container Security Analysis
    runs-on: ubuntu-latest
    needs: [security-setup]
    if: needs.security-setup.outputs.scan_containers == 'true'

    strategy:
      matrix:
        image-type: [prod, dev, dev-enhanced]
        include:
          - image-type: prod
            dockerfile: docker/Dockerfile.prod
            context: .
          - image-type: dev
            dockerfile: docker/Dockerfile.dev
            context: .
          - image-type: dev-enhanced
            dockerfile: docker/Dockerfile.dev-enhanced
            context: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for security scanning
        run: |
          echo "üèóÔ∏è Building ${{ matrix.image-type }} image for security analysis..."
          docker build -f ${{ matrix.dockerfile }} -t synthatrial:security-scan-${{ matrix.image-type }} ${{ matrix.context }}

      - name: Install comprehensive security scanners
        run: |
          echo "üîß Installing security scanning tools..."

          # Install Trivy
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

          # Install Grype
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

          # Install Syft for SBOM generation
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate container SBOM
        run: |
          echo "üìã Generating Software Bill of Materials..."

          # Generate SBOM with Syft
          syft synthatrial:security-scan-${{ matrix.image-type }} -o json > ${{ env.SECURITY_REPORT_DIR }}/sbom-${{ matrix.image-type }}.json
          syft synthatrial:security-scan-${{ matrix.image-type }} -o spdx-json > ${{ env.SECURITY_REPORT_DIR }}/sbom-spdx-${{ matrix.image-type }}.json
          syft synthatrial:security-scan-${{ matrix.image-type }} -o cyclonedx-json > ${{ env.SECURITY_REPORT_DIR }}/sbom-cyclonedx-${{ matrix.image-type }}.json
          syft synthatrial:security-scan-${{ matrix.image-type }} -o table > ${{ env.SECURITY_REPORT_DIR }}/sbom-${{ matrix.image-type }}.txt

      - name: Run comprehensive Trivy vulnerability scan
        run: |
          echo "üîç Running Trivy vulnerability analysis..."

          # Comprehensive vulnerability scan
          trivy image --format json --output ${{ env.SECURITY_REPORT_DIR }}/trivy-vuln-${{ matrix.image-type }}.json synthatrial:security-scan-${{ matrix.image-type }}
          trivy image --format table --output ${{ env.SECURITY_REPORT_DIR }}/trivy-vuln-${{ matrix.image-type }}.txt synthatrial:security-scan-${{ matrix.image-type }}
          trivy image --format sarif --output ${{ env.SECURITY_REPORT_DIR }}/trivy-vuln-${{ matrix.image-type }}.sarif synthatrial:security-scan-${{ matrix.image-type }}

          # Configuration scan (Dockerfile and misconfigurations)
          trivy config --format json --output ${{ env.SECURITY_REPORT_DIR }}/trivy-config-${{ matrix.image-type }}.json .
          trivy config --format table --output ${{ env.SECURITY_REPORT_DIR }}/trivy-config-${{ matrix.image-type }}.txt .

          # Secret scan
          trivy fs --scanners secret --format json --output ${{ env.SECURITY_REPORT_DIR }}/trivy-secrets-${{ matrix.image-type }}.json .
          trivy fs --scanners secret --format table --output ${{ env.SECURITY_REPORT_DIR }}/trivy-secrets-${{ matrix.image-type }}.txt .

          # License scan
          trivy fs --scanners license --format json --output ${{ env.SECURITY_REPORT_DIR }}/trivy-licenses-${{ matrix.image-type }}.json .
        continue-on-error: true

      - name: Run Grype vulnerability scan
        run: |
          echo "üîç Running Grype vulnerability analysis..."

          # Run Grype scan with multiple output formats
          grype synthatrial:security-scan-${{ matrix.image-type }} -o json > ${{ env.SECURITY_REPORT_DIR }}/grype-${{ matrix.image-type }}.json
          grype synthatrial:security-scan-${{ matrix.image-type }} -o table > ${{ env.SECURITY_REPORT_DIR }}/grype-${{ matrix.image-type }}.txt
          grype synthatrial:security-scan-${{ matrix.image-type }} -o sarif > ${{ env.SECURITY_REPORT_DIR }}/grype-${{ matrix.image-type }}.sarif

          # Scan with different severity thresholds
          grype synthatrial:security-scan-${{ matrix.image-type }} --fail-on high -o json > ${{ env.SECURITY_REPORT_DIR }}/grype-high-${{ matrix.image-type }}.json || true
          grype synthatrial:security-scan-${{ matrix.image-type }} --fail-on critical -o json > ${{ env.SECURITY_REPORT_DIR }}/grype-critical-${{ matrix.image-type }}.json || true
        continue-on-error: true

      - name: Run Docker security best practices check
        run: |
          echo "üîç Running Docker security best practices analysis..."

          # Use our security scanner script if available
          if [ -f scripts/security_scanner.py ]; then
            python3 scripts/security_scanner.py \
              --image synthatrial:security-scan-${{ matrix.image-type }} \
              --output-format json \
              --output-dir ${{ env.SECURITY_REPORT_DIR }} \
              --verbose || true
          fi

          # Docker Scout scan (if available)
          if command -v docker &> /dev/null; then
            docker scout cves synthatrial:security-scan-${{ matrix.image-type }} --format json --output ${{ env.SECURITY_REPORT_DIR }}/docker-scout-${{ matrix.image-type }}.json || true
            docker scout cves synthatrial:security-scan-${{ matrix.image-type }} --format sarif --output ${{ env.SECURITY_REPORT_DIR }}/docker-scout-${{ matrix.image-type }}.sarif || true
          fi
        continue-on-error: true

      - name: Analyze container security posture
        id: container_analysis
        run: |
          echo "üìä Analyzing container security posture..."

          python3 << 'EOF'
          import json
          import os
          from pathlib import Path

          report_dir = Path("${{ env.SECURITY_REPORT_DIR }}")
          image_type = "${{ matrix.image-type }}"

          # Initialize analysis results
          analysis = {
              "image_type": image_type,
              "total_vulnerabilities": 0,
              "severity_counts": {"critical": 0, "high": 0, "medium": 0, "low": 0, "unknown": 0},
              "scanners_used": [],
              "recommendations": []
          }

          # Analyze Trivy results
          trivy_file = report_dir / f"trivy-vuln-{image_type}.json"
          if trivy_file.exists():
              analysis["scanners_used"].append("trivy")
              try:
                  with open(trivy_file) as f:
                      trivy_data = json.load(f)

                  for result in trivy_data.get("Results", []):
                      for vuln in result.get("Vulnerabilities", []):
                          analysis["total_vulnerabilities"] += 1
                          severity = vuln.get("Severity", "unknown").lower()
                          analysis["severity_counts"][severity] = analysis["severity_counts"].get(severity, 0) + 1
              except Exception as e:
                  print(f"Error processing Trivy report: {e}")

          # Analyze Grype results
          grype_file = report_dir / f"grype-{image_type}.json"
          if grype_file.exists():
              analysis["scanners_used"].append("grype")
              try:
                  with open(grype_file) as f:
                      grype_data = json.load(f)

                  for match in grype_data.get("matches", []):
                      vuln = match.get("vulnerability", {})
                      severity = vuln.get("severity", "unknown").lower()
                      analysis["severity_counts"][severity] = analysis["severity_counts"].get(severity, 0) + 1
              except Exception as e:
                  print(f"Error processing Grype report: {e}")

          # Generate recommendations
          critical_count = analysis["severity_counts"]["critical"]
          high_count = analysis["severity_counts"]["high"]

          if critical_count > 0:
              analysis["recommendations"].append(f"üö® CRITICAL: {critical_count} critical vulnerabilities require immediate attention")

          if high_count > 0:
              analysis["recommendations"].append(f"‚ö†Ô∏è HIGH: {high_count} high-severity vulnerabilities should be addressed")

          if analysis["total_vulnerabilities"] > 50:
              analysis["recommendations"].append("üê≥ Consider using a more secure base image to reduce attack surface")

          if analysis["total_vulnerabilities"] == 0:
              analysis["recommendations"].append("‚úÖ Excellent security posture - no vulnerabilities detected")

          # Save analysis
          with open(report_dir / f"container-analysis-{image_type}.json", "w") as f:
              json.dump(analysis, f, indent=2)

          # Generate markdown report
          with open(report_dir / f"container-security-{image_type}.md", "w") as f:
              f.write(f"# Container Security Analysis - {image_type.upper()}\n\n")
              f.write(f"**Total Vulnerabilities:** {analysis['total_vulnerabilities']}\n")
              f.write(f"**Scanners Used:** {', '.join(analysis['scanners_used'])}\n\n")

              f.write("## Severity Breakdown\n")
              for severity, count in analysis["severity_counts"].items():
                  if count > 0:
                      f.write(f"- **{severity.upper()}:** {count}\n")

              if analysis["recommendations"]:
                  f.write("\n## Recommendations\n")
                  for rec in analysis["recommendations"]:
                      f.write(f"- {rec}\n")

          # Set outputs for threshold checking
          print(f"container_vulnerabilities_{image_type}={analysis['total_vulnerabilities']}")
          print(f"container_critical_{image_type}={critical_count}")
          print(f"container_high_{image_type}={high_count}")

          # Check thresholds
          threshold = "${{ needs.security-setup.outputs.severity_threshold }}"
          fail_on_high = "${{ needs.security-setup.outputs.fail_on_high }}"

          threshold_exceeded = False
          if fail_on_high == "true":
              if threshold == "critical" and critical_count > 0:
                  threshold_exceeded = True
              elif threshold in ["high", "medium", "low"] and (critical_count > 0 or high_count > 0):
                  threshold_exceeded = True

          print(f"container_threshold_exceeded_{image_type}={str(threshold_exceeded).lower()}")
          EOF

      - name: Check container security thresholds
        run: |
          echo "üö® Checking container security thresholds for ${{ matrix.image-type }}..."

          # Read analysis results
          if [ -f ${{ env.SECURITY_REPORT_DIR }}/container-analysis-${{ matrix.image-type }}.json ]; then
            TOTAL_VULNS=$(python3 -c "
            import json
            with open('${{ env.SECURITY_REPORT_DIR }}/container-analysis-${{ matrix.image-type }}.json') as f:
                data = json.load(f)
            print(data['total_vulnerabilities'])
            ")

            CRITICAL_VULNS=$(python3 -c "
            import json
            with open('${{ env.SECURITY_REPORT_DIR }}/container-analysis-${{ matrix.image-type }}.json') as f:
                data = json.load(f)
            print(data['severity_counts']['critical'])
            ")

            HIGH_VULNS=$(python3 -c "
            import json
            with open('${{ env.SECURITY_REPORT_DIR }}/container-analysis-${{ matrix.image-type }}.json') as f:
                data = json.load(f)
            print(data['severity_counts']['high'])
            ")

            echo "Container ${{ matrix.image-type }}: $TOTAL_VULNS total vulnerabilities ($CRITICAL_VULNS critical, $HIGH_VULNS high)"

            # Check if we should fail the build
            THRESHOLD="${{ needs.security-setup.outputs.severity_threshold }}"
            FAIL_ON_HIGH="${{ needs.security-setup.outputs.fail_on_high }}"

            if [ "$FAIL_ON_HIGH" = "true" ]; then
              if [ "$THRESHOLD" = "critical" ] && [ "$CRITICAL_VULNS" -gt 0 ]; then
                echo "‚ùå Build should fail: Critical vulnerabilities found in ${{ matrix.image-type }} image"
                echo "CONTAINER_SECURITY_FAILED=true" >> $GITHUB_ENV
              elif [ "$CRITICAL_VULNS" -gt 0 ] || [ "$HIGH_VULNS" -gt 0 ]; then
                echo "‚ùå Build should fail: High+ severity vulnerabilities found in ${{ matrix.image-type }} image"
                echo "CONTAINER_SECURITY_FAILED=true" >> $GITHUB_ENV
              fi
            fi
          fi

      - name: Upload SARIF results to GitHub Security
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: ${{ env.SECURITY_REPORT_DIR }}/trivy-vuln-${{ matrix.image-type }}.sarif
        continue-on-error: true

      - name: Upload container security reports
        uses: actions/upload-artifact@v4
        with:
          name: container-security-reports-${{ matrix.image-type }}
          path: |
            ${{ env.SECURITY_REPORT_DIR }}/trivy-*-${{ matrix.image-type }}.*
            ${{ env.SECURITY_REPORT_DIR }}/grype-*-${{ matrix.image-type }}.*
            ${{ env.SECURITY_REPORT_DIR }}/docker-scout-${{ matrix.image-type }}.*
            ${{ env.SECURITY_REPORT_DIR }}/sbom-*-${{ matrix.image-type }}.*
            ${{ env.SECURITY_REPORT_DIR }}/container-*-${{ matrix.image-type }}.*

  # Job 5: Infrastructure Security Analysis
  infrastructure-security:
    name: Infrastructure Security Analysis
    runs-on: ubuntu-latest
    needs: [security-setup]
    if: needs.security-setup.outputs.scan_infrastructure == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install infrastructure security tools
        run: |
          echo "üîß Installing infrastructure security tools..."

          # Install Checkov for IaC scanning
          pip install checkov

          # Install tfsec for Terraform scanning (if needed)
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

          # Install hadolint for Dockerfile linting
          wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/

      - name: Run Dockerfile security analysis
        run: |
          echo "üîç Analyzing Dockerfile security..."

          # Scan all Dockerfiles with hadolint
          find . -name "Dockerfile*" -type f | while read dockerfile; do
            echo "Scanning $dockerfile..."
            hadolint "$dockerfile" --format json > "${{ env.SECURITY_REPORT_DIR }}/hadolint-$(basename $dockerfile).json" || true
            hadolint "$dockerfile" > "${{ env.SECURITY_REPORT_DIR }}/hadolint-$(basename $dockerfile).txt" || true
          done

      - name: Run Docker Compose security analysis
        run: |
          echo "üîç Analyzing Docker Compose security..."

          # Scan Docker Compose files
          find . -name "docker-compose*.yml" -type f | while read composefile; do
            echo "Scanning $composefile..."

            # Use Checkov for Docker Compose analysis
            checkov -f "$composefile" --framework docker_compose \
              --output json --output-file "${{ env.SECURITY_REPORT_DIR }}/checkov-$(basename $composefile).json" || true
            checkov -f "$composefile" --framework docker_compose \
              > "${{ env.SECURITY_REPORT_DIR }}/checkov-$(basename $composefile).txt" || true
          done

      - name: Run GitHub Actions workflow security analysis
        run: |
          echo "üîç Analyzing GitHub Actions security..."

          # Scan GitHub Actions workflows
          if [ -d .github/workflows ]; then
            checkov -d .github/workflows --framework github_actions \
              --output json --output-file "${{ env.SECURITY_REPORT_DIR }}/checkov-github-actions.json" || true
            checkov -d .github/workflows --framework github_actions \
              > "${{ env.SECURITY_REPORT_DIR }}/checkov-github-actions.txt" || true
          fi

      - name: Run configuration security analysis
        run: |
          echo "üîç Analyzing configuration security..."

          # Scan for general configuration issues
          checkov -d . --framework dockerfile --framework docker_compose --framework github_actions \
            --output json --output-file "${{ env.SECURITY_REPORT_DIR }}/checkov-all-configs.json" || true
          checkov -d . --framework dockerfile --framework docker_compose --framework github_actions \
            > "${{ env.SECURITY_REPORT_DIR }}/checkov-all-configs.txt" || true

      - name: Analyze infrastructure security posture
        run: |
          echo "üìä Analyzing infrastructure security posture..."

          python3 << 'EOF'
          import json
          import os
          from pathlib import Path
          import glob

          report_dir = Path("${{ env.SECURITY_REPORT_DIR }}")

          # Initialize analysis
          analysis = {
              "dockerfile_issues": 0,
              "compose_issues": 0,
              "github_actions_issues": 0,
              "total_issues": 0,
              "severity_counts": {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0},
              "recommendations": []
          }

          # Process Hadolint results
          for hadolint_file in glob.glob(str(report_dir / "hadolint-*.json")):
              try:
                  with open(hadolint_file) as f:
                      hadolint_data = json.load(f)

                  if isinstance(hadolint_data, list):
                      for issue in hadolint_data:
                          analysis["dockerfile_issues"] += 1
                          analysis["total_issues"] += 1

                          # Map hadolint levels to our severity
                          level = issue.get("level", "info").lower()
                          if level == "error":
                              analysis["severity_counts"]["high"] += 1
                          elif level == "warning":
                              analysis["severity_counts"]["medium"] += 1
                          else:
                              analysis["severity_counts"]["info"] += 1
              except Exception as e:
                  print(f"Error processing {hadolint_file}: {e}")

          # Process Checkov results
          for checkov_file in glob.glob(str(report_dir / "checkov-*.json")):
              try:
                  with open(checkov_file) as f:
                      checkov_data = json.load(f)

                  # Count failed checks
                  failed_checks = checkov_data.get("results", {}).get("failed_checks", [])
                  for check in failed_checks:
                      analysis["total_issues"] += 1

                      # Determine category
                      if "docker-compose" in checkov_file:
                          analysis["compose_issues"] += 1
                      elif "github-actions" in checkov_file:
                          analysis["github_actions_issues"] += 1

                      # Map severity (Checkov uses different levels)
                      severity = check.get("severity", "MEDIUM").lower()
                      if severity in ["critical", "high"]:
                          analysis["severity_counts"]["high"] += 1
                      elif severity == "medium":
                          analysis["severity_counts"]["medium"] += 1
                      else:
                          analysis["severity_counts"]["low"] += 1
              except Exception as e:
                  print(f"Error processing {checkov_file}: {e}")

          # Generate recommendations
          if analysis["dockerfile_issues"] > 0:
              analysis["recommendations"].append(f"üê≥ {analysis['dockerfile_issues']} Dockerfile security issues found - review and fix")

          if analysis["compose_issues"] > 0:
              analysis["recommendations"].append(f"üìã {analysis['compose_issues']} Docker Compose security issues found")

          if analysis["github_actions_issues"] > 0:
              analysis["recommendations"].append(f"‚öôÔ∏è {analysis['github_actions_issues']} GitHub Actions security issues found")

          if analysis["total_issues"] == 0:
              analysis["recommendations"].append("‚úÖ No infrastructure security issues detected")

          # Save analysis
          with open(report_dir / "infrastructure-analysis.json", "w") as f:
              json.dump(analysis, f, indent=2)

          # Generate markdown report
          with open(report_dir / "infrastructure-security-summary.md", "w") as f:
              f.write("# Infrastructure Security Analysis Summary\n\n")
              f.write(f"**Total Issues:** {analysis['total_issues']}\n")
              f.write(f"**Dockerfile Issues:** {analysis['dockerfile_issues']}\n")
              f.write(f"**Docker Compose Issues:** {analysis['compose_issues']}\n")
              f.write(f"**GitHub Actions Issues:** {analysis['github_actions_issues']}\n\n")

              f.write("## Severity Breakdown\n")
              for severity, count in analysis["severity_counts"].items():
                  if count > 0:
                      f.write(f"- **{severity.upper()}:** {count}\n")

              if analysis["recommendations"]:
                  f.write("\n## Recommendations\n")
                  for rec in analysis["recommendations"]:
                      f.write(f"- {rec}\n")

          print(f"Infrastructure analysis complete: {analysis['total_issues']} issues found")
          EOF

      - name: Upload infrastructure security reports
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-security-reports
          path: |
            ${{ env.SECURITY_REPORT_DIR }}/hadolint-*
            ${{ env.SECURITY_REPORT_DIR }}/checkov-*
            ${{ env.SECURITY_REPORT_DIR }}/infrastructure-*

  # Job 6: Security Threshold Validation and Build Control
  security-validation:
    name: Security Validation & Build Control
    runs-on: ubuntu-latest
    needs:
      [
        security-setup,
        code-security,
        dependency-security,
        container-security,
        infrastructure-security,
      ]
    if: always()
    outputs:
      security_passed: ${{ steps.validation.outputs.security_passed }}
      critical_issues_found: ${{ steps.validation.outputs.critical_issues_found }}
      should_create_issues: ${{ steps.validation.outputs.should_create_issues }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all security reports
        uses: actions/download-artifact@v4

      - name: Comprehensive security validation
        id: validation
        run: |
          echo "üîç Performing comprehensive security validation..."

          python3 << 'EOF'
          import json
          import os
          from pathlib import Path
          import glob

          # Configuration from workflow inputs
          severity_threshold = "${{ needs.security-setup.outputs.severity_threshold }}"
          fail_on_high = "${{ needs.security-setup.outputs.fail_on_high }}" == "true"

          # Initialize validation results
          validation = {
              "total_vulnerabilities": 0,
              "critical_vulnerabilities": 0,
              "high_vulnerabilities": 0,
              "medium_vulnerabilities": 0,
              "low_vulnerabilities": 0,
              "code_issues": 0,
              "dependency_issues": 0,
              "container_issues": 0,
              "infrastructure_issues": 0,
              "security_passed": True,
              "critical_issues_found": False,
              "failure_reasons": []
          }

          # Process code security results
          code_reports = glob.glob("code-security-reports/**/*.json", recursive=True)
          for report_file in code_reports:
              try:
                  with open(report_file) as f:
                      data = json.load(f)

                  # Process different report formats
                  if "bandit" in report_file:
                      results = data.get("results", [])
                      validation["code_issues"] += len(results)
                      for result in results:
                          severity = result.get("issue_severity", "MEDIUM").lower()
                          if severity == "high":
                              validation["high_vulnerabilities"] += 1
                          elif severity == "medium":
                              validation["medium_vulnerabilities"] += 1
                          else:
                              validation["low_vulnerabilities"] += 1

                  elif "semgrep" in report_file:
                      results = data.get("results", [])
                      validation["code_issues"] += len(results)
                      for result in results:
                          severity = result.get("extra", {}).get("severity", "WARNING").lower()
                          if severity == "error":
                              validation["high_vulnerabilities"] += 1
                          else:
                              validation["medium_vulnerabilities"] += 1
              except Exception as e:
                  print(f"Error processing code security report {report_file}: {e}")

          # Process dependency security results
          dep_reports = glob.glob("dependency-security-reports/**/*summary*.json", recursive=True)
          for report_file in dep_reports:
              try:
                  with open(report_file) as f:
                      data = json.load(f)

                  validation["dependency_issues"] += data.get("total_vulnerabilities", 0)
                  severity_counts = data.get("severity_breakdown", {})
                  validation["critical_vulnerabilities"] += severity_counts.get("critical", 0)
                  validation["high_vulnerabilities"] += severity_counts.get("high", 0)
                  validation["medium_vulnerabilities"] += severity_counts.get("medium", 0)
                  validation["low_vulnerabilities"] += severity_counts.get("low", 0)
              except Exception as e:
                  print(f"Error processing dependency report {report_file}: {e}")

          # Process container security results
          container_reports = glob.glob("container-security-reports-*/**/container-analysis-*.json", recursive=True)
          for report_file in container_reports:
              try:
                  with open(report_file) as f:
                      data = json.load(f)

                  validation["container_issues"] += data.get("total_vulnerabilities", 0)
                  severity_counts = data.get("severity_counts", {})
                  validation["critical_vulnerabilities"] += severity_counts.get("critical", 0)
                  validation["high_vulnerabilities"] += severity_counts.get("high", 0)
                  validation["medium_vulnerabilities"] += severity_counts.get("medium", 0)
                  validation["low_vulnerabilities"] += severity_counts.get("low", 0)
              except Exception as e:
                  print(f"Error processing container report {report_file}: {e}")

          # Process infrastructure security results
          infra_reports = glob.glob("infrastructure-security-reports/**/infrastructure-analysis.json", recursive=True)
          for report_file in infra_reports:
              try:
                  with open(report_file) as f:
                      data = json.load(f)

                  validation["infrastructure_issues"] += data.get("total_issues", 0)
                  severity_counts = data.get("severity_counts", {})
                  validation["critical_vulnerabilities"] += severity_counts.get("critical", 0)
                  validation["high_vulnerabilities"] += severity_counts.get("high", 0)
                  validation["medium_vulnerabilities"] += severity_counts.get("medium", 0)
                  validation["low_vulnerabilities"] += severity_counts.get("low", 0)
              except Exception as e:
                  print(f"Error processing infrastructure report {report_file}: {e}")

          # Calculate totals
          validation["total_vulnerabilities"] = (
              validation["critical_vulnerabilities"] +
              validation["high_vulnerabilities"] +
              validation["medium_vulnerabilities"] +
              validation["low_vulnerabilities"]
          )

          # Determine if critical issues were found
          if validation["critical_vulnerabilities"] > 0:
              validation["critical_issues_found"] = True
              validation["failure_reasons"].append(f"Critical vulnerabilities found: {validation['critical_vulnerabilities']}")

          # Apply threshold-based validation
          if fail_on_high:
              if severity_threshold == "critical" and validation["critical_vulnerabilities"] > 0:
                  validation["security_passed"] = False
                  validation["failure_reasons"].append("Critical vulnerabilities exceed threshold")
              elif severity_threshold in ["high", "medium", "low"]:
                  high_plus_critical = validation["critical_vulnerabilities"] + validation["high_vulnerabilities"]
                  if high_plus_critical > 0:
                      validation["security_passed"] = False
                      validation["failure_reasons"].append(f"High+ severity vulnerabilities exceed threshold: {high_plus_critical}")

          # Save validation results
          with open("security-validation-results.json", "w") as f:
              json.dump(validation, f, indent=2)

          # Set GitHub outputs
          print(f"security_passed={str(validation['security_passed']).lower()}")
          print(f"critical_issues_found={str(validation['critical_issues_found']).lower()}")
          print(f"should_create_issues={str(validation['critical_issues_found']).lower()}")

          # Print summary
          print(f"\nüîí Security Validation Summary:")
          print(f"Total Vulnerabilities: {validation['total_vulnerabilities']}")
          print(f"Critical: {validation['critical_vulnerabilities']}")
          print(f"High: {validation['high_vulnerabilities']}")
          print(f"Medium: {validation['medium_vulnerabilities']}")
          print(f"Low: {validation['low_vulnerabilities']}")
          print(f"Security Passed: {validation['security_passed']}")

          if validation["failure_reasons"]:
              print(f"\nFailure Reasons:")
              for reason in validation["failure_reasons"]:
                  print(f"- {reason}")

          # Exit with appropriate code
          if not validation["security_passed"]:
              exit(1)
          EOF

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: security-validation-results
          path: security-validation-results.json

  # Job 7: Comprehensive Security Report Generation
  security-report:
    name: Generate Comprehensive Security Report
    runs-on: ubuntu-latest
    needs:
      [
        security-setup,
        code-security,
        dependency-security,
        container-security,
        infrastructure-security,
        security-validation,
      ]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all security artifacts
        uses: actions/download-artifact@v4

      - name: Generate comprehensive security report
        run: |
          echo "üìä Generating comprehensive security report..."

          python3 << 'EOF'
          import json
          import os
          from pathlib import Path
          from datetime import datetime
          import glob

          # Initialize comprehensive report
          report = {
              "scan_metadata": {
                  "scan_date": datetime.now().isoformat(),
                  "repository": "${{ github.repository }}",
                  "commit": "${{ github.sha }}",
                  "trigger": "${{ github.event_name }}",
                  "workflow_run": "${{ github.run_id }}",
                  "scan_timestamp": "${{ needs.security-setup.outputs.scan_timestamp }}"
              },
              "scan_configuration": {
                  "severity_threshold": "${{ needs.security-setup.outputs.severity_threshold }}",
                  "fail_on_high": "${{ needs.security-setup.outputs.fail_on_high }}",
                  "scans_performed": {
                      "code": "${{ needs.security-setup.outputs.scan_code }}",
                      "dependencies": "${{ needs.security-setup.outputs.scan_dependencies }}",
                      "containers": "${{ needs.security-setup.outputs.scan_containers }}",
                      "infrastructure": "${{ needs.security-setup.outputs.scan_infrastructure }}"
                  }
              },
              "job_status": {
                  "code_security": "${{ needs.code-security.result }}",
                  "dependency_security": "${{ needs.dependency-security.result }}",
                  "container_security": "${{ needs.container-security.result }}",
                  "infrastructure_security": "${{ needs.infrastructure-security.result }}",
                  "security_validation": "${{ needs.security-validation.result }}"
              },
              "security_summary": {
                  "total_vulnerabilities": 0,
                  "severity_breakdown": {"critical": 0, "high": 0, "medium": 0, "low": 0, "unknown": 0},
                  "category_breakdown": {"code": 0, "dependencies": 0, "containers": 0, "infrastructure": 0},
                  "security_passed": "${{ needs.security-validation.outputs.security_passed }}",
                  "critical_issues_found": "${{ needs.security-validation.outputs.critical_issues_found }}"
              },
              "detailed_findings": {
                  "code_security": [],
                  "dependency_security": [],
                  "container_security": [],
                  "infrastructure_security": []
              },
              "recommendations": [],
              "artifacts_generated": []
          }

          # Load validation results if available
          validation_file = Path("security-validation-results/security-validation-results.json")
          if validation_file.exists():
              try:
                  with open(validation_file) as f:
                      validation_data = json.load(f)

                  report["security_summary"]["total_vulnerabilities"] = validation_data.get("total_vulnerabilities", 0)
                  report["security_summary"]["severity_breakdown"]["critical"] = validation_data.get("critical_vulnerabilities", 0)
                  report["security_summary"]["severity_breakdown"]["high"] = validation_data.get("high_vulnerabilities", 0)
                  report["security_summary"]["severity_breakdown"]["medium"] = validation_data.get("medium_vulnerabilities", 0)
                  report["security_summary"]["severity_breakdown"]["low"] = validation_data.get("low_vulnerabilities", 0)

                  report["security_summary"]["category_breakdown"]["code"] = validation_data.get("code_issues", 0)
                  report["security_summary"]["category_breakdown"]["dependencies"] = validation_data.get("dependency_issues", 0)
                  report["security_summary"]["category_breakdown"]["containers"] = validation_data.get("container_issues", 0)
                  report["security_summary"]["category_breakdown"]["infrastructure"] = validation_data.get("infrastructure_issues", 0)
              except Exception as e:
                  print(f"Error loading validation results: {e}")

          # Generate recommendations based on findings
          critical_count = report["security_summary"]["severity_breakdown"]["critical"]
          high_count = report["security_summary"]["severity_breakdown"]["high"]
          total_count = report["security_summary"]["total_vulnerabilities"]

          if critical_count > 0:
              report["recommendations"].append(f"üö® URGENT: {critical_count} critical vulnerabilities require immediate attention")
              report["recommendations"].append("üîí Block production deployment until critical issues are resolved")

          if high_count > 0:
              report["recommendations"].append(f"‚ö†Ô∏è HIGH PRIORITY: {high_count} high-severity vulnerabilities need remediation")
              report["recommendations"].append("üìÖ Plan remediation within 7 days for high-severity issues")

          if total_count > 50:
              report["recommendations"].append("üê≥ Consider using more secure base images to reduce attack surface")
              report["recommendations"].append("üì¶ Implement automated dependency updates")

          if total_count > 0:
              report["recommendations"].extend([
                  "üîÑ Integrate security scanning into CI/CD pipeline",
                  "üìã Establish vulnerability management process with SLAs",
                  "üéØ Implement security training for development team"
              ])

          if total_count == 0:
              report["recommendations"].append("‚úÖ Excellent security posture - maintain regular scanning")

          # List all generated artifacts
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file.endswith(('.json', '.txt', '.html', '.sarif', '.xml', '.csv', '.md')):
                      report["artifacts_generated"].append(os.path.join(root, file))

          # Save comprehensive report
          with open("comprehensive-security-report.json", "w") as f:
              json.dump(report, f, indent=2, default=str)

          # Generate markdown summary
          with open("security-summary.md", "w") as f:
              f.write("# üîí SynthaTrial Security Scan Report\n\n")
              f.write(f"**Scan Date:** {report['scan_metadata']['scan_date']}\n")
              f.write(f"**Repository:** {report['scan_metadata']['repository']}\n")
              f.write(f"**Commit:** {report['scan_metadata']['commit']}\n")
              f.write(f"**Trigger:** {report['scan_metadata']['trigger']}\n")
              f.write(f"**Workflow Run:** [{report['scan_metadata']['workflow_run']}](https://github.com/{report['scan_metadata']['repository']}/actions/runs/{report['scan_metadata']['workflow_run']})\n\n")

              f.write("## üìä Security Summary\n\n")
              f.write(f"**Total Vulnerabilities:** {report['security_summary']['total_vulnerabilities']}\n")
              f.write(f"**Security Status:** {'‚úÖ PASSED' if report['security_summary']['security_passed'] == 'true' else '‚ùå FAILED'}\n")
              f.write(f"**Critical Issues:** {'üö® YES' if report['security_summary']['critical_issues_found'] == 'true' else '‚úÖ NO'}\n\n")

              f.write("### Severity Breakdown\n")
              for severity, count in report["security_summary"]["severity_breakdown"].items():
                  if count > 0:
                      emoji = {"critical": "üö®", "high": "‚ö†Ô∏è", "medium": "üü°", "low": "üîµ"}.get(severity, "‚ö™")
                      f.write(f"- {emoji} **{severity.upper()}:** {count}\n")

              f.write("\n### Category Breakdown\n")
              for category, count in report["security_summary"]["category_breakdown"].items():
                  if count > 0:
                      emoji = {"code": "üíª", "dependencies": "üì¶", "containers": "üê≥", "infrastructure": "üèóÔ∏è"}.get(category, "üìã")
                      f.write(f"- {emoji} **{category.title()}:** {count}\n")

              f.write("\n## üéØ Job Status\n")
              for job, status in report["job_status"].items():
                  status_emoji = "‚úÖ" if status == "success" else "‚ùå" if status == "failure" else "‚ö†Ô∏è"
                  f.write(f"- {status_emoji} **{job.replace('_', ' ').title()}:** {status}\n")

              if report["recommendations"]:
                  f.write("\n## üìã Recommendations\n")
                  for rec in report["recommendations"]:
                      f.write(f"- {rec}\n")

              f.write(f"\n## üìÅ Artifacts Generated\n")
              f.write(f"**Total Files:** {len(report['artifacts_generated'])}\n\n")
              f.write("Download all security reports from the workflow artifacts section.\n")

          print(f"Comprehensive security report generated with {report['security_summary']['total_vulnerabilities']} total vulnerabilities")
          EOF

      - name: Upload comprehensive security report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-report
          path: |
            comprehensive-security-report.json
            security-summary.md

  # Job 8: Automated Issue Creation for Critical Vulnerabilities
  create-security-issues:
    name: Create Security Issues
    runs-on: ubuntu-latest
    needs: [security-setup, security-validation, security-report]
    if: needs.security-validation.outputs.critical_issues_found == 'true' && needs.security-setup.outputs.create_issues == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: comprehensive-security-report

      - name: Create critical security issue
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // Read the comprehensive security report
            let reportData = {};
            try {
              const reportContent = fs.readFileSync('comprehensive-security-report.json', 'utf8');
              reportData = JSON.parse(reportContent);
            } catch (error) {
              console.log('Could not read security report, creating basic issue');
            }

            // Read the markdown summary
            let summaryContent = '';
            try {
              summaryContent = fs.readFileSync('security-summary.md', 'utf8');
            } catch (error) {
              console.log('Could not read security summary');
            }

            const criticalCount = reportData.security_summary?.severity_breakdown?.critical || 0;
            const highCount = reportData.security_summary?.severity_breakdown?.high || 0;
            const totalCount = reportData.security_summary?.total_vulnerabilities || 0;

            const issueTitle = `üö® Critical Security Vulnerabilities Detected - ${criticalCount} Critical, ${highCount} High`;

            const issueBody = `# üö® Critical Security Vulnerabilities Detected

            Critical security vulnerabilities have been detected in the latest security scan and require immediate attention.

            ## üìä Vulnerability Summary
            - **Critical Vulnerabilities:** ${criticalCount}
            - **High Severity Vulnerabilities:** ${highCount}
            - **Total Vulnerabilities:** ${totalCount}

            ## üîç Scan Details
            - **Repository:** ${{ github.repository }}
            - **Commit:** ${{ github.sha }}
            - **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Scan Date:** ${reportData.scan_metadata?.scan_date || new Date().toISOString()}

            ## üìã Security Report Summary
            ${summaryContent || 'Security report summary not available - please check workflow artifacts.'}

            ## üéØ Immediate Actions Required

            ### Critical Priority (Fix Immediately)
            - [ ] Review all critical vulnerabilities in the security reports
            - [ ] Update vulnerable dependencies to patched versions
            - [ ] Apply security patches to container base images
            - [ ] Fix critical code security issues identified by static analysis

            ### High Priority (Fix Within 7 Days)
            - [ ] Address high-severity vulnerabilities
            - [ ] Review and update security policies
            - [ ] Implement additional security controls if needed

            ### Process Improvements
            - [ ] Review why these vulnerabilities were not caught earlier
            - [ ] Update security scanning thresholds if needed
            - [ ] Consider implementing pre-commit security hooks
            - [ ] Schedule regular security training for the team

            ## üìÅ Security Reports

            Download the complete security analysis from the workflow artifacts:
            - **Comprehensive Report:** \`comprehensive-security-report.json\`
            - **Code Security Reports:** \`code-security-reports\`
            - **Dependency Security Reports:** \`dependency-security-reports\`
            - **Container Security Reports:** \`container-security-reports-*\`
            - **Infrastructure Security Reports:** \`infrastructure-security-reports\`

            ## üîí Security Policy

            This issue was automatically created by the security scanning workflow. Critical vulnerabilities must be addressed before any production deployments.

            **Security Contact:** Please escalate to the security team if immediate assistance is needed.

            ---

            *This issue was automatically created by the SynthaTrial Security Scanning Workflow*
            *Workflow Run ID: ${{ github.run_id }}*`;

            // Create the issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['security', 'critical', 'automated', 'vulnerability'],
              assignees: [] // Add default assignees if needed
            });

            console.log(`Created security issue #${issue.data.number}: ${issue.data.html_url}`);

            // Add a comment with additional context if this is a recurring issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,critical',
              state: 'open'
            });

            if (existingIssues.data.length > 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.data.number,
                body: `‚ö†Ô∏è **Note:** There are ${existingIssues.data.length} open critical security issues. This indicates a pattern that may require immediate security team attention.`
              });
            }

      - name: Create dependency update issue (if needed)
        if: needs.dependency-security.result == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            // Create a separate issue for dependency updates if there are many dependency vulnerabilities
            const fs = require('fs');

            let reportData = {};
            try {
              const reportContent = fs.readFileSync('comprehensive-security-report.json', 'utf8');
              reportData = JSON.parse(reportContent);
            } catch (error) {
              console.log('Could not read security report');
              return;
            }

            const depIssues = reportData.security_summary?.category_breakdown?.dependencies || 0;

            if (depIssues > 10) {
              const issueTitle = `üì¶ Dependency Security Update Required - ${depIssues} Vulnerable Dependencies`;

              const issueBody = `# üì¶ Dependency Security Update Required

              The security scan has identified ${depIssues} vulnerable dependencies that need to be updated.

              ## üîç Scan Details
              - **Repository:** ${{ github.repository }}
              - **Commit:** ${{ github.sha }}
              - **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

              ## üìã Action Items
              - [ ] Review dependency security reports in workflow artifacts
              - [ ] Update vulnerable packages to latest secure versions
              - [ ] Test application functionality after updates
              - [ ] Consider implementing automated dependency updates (Dependabot)
              - [ ] Review and update dependency management policies

              ## üìÅ Reports
              Check the \`dependency-security-reports\` artifact for detailed vulnerability information.

              ---
              *This issue was automatically created by the SynthaTrial Security Scanning Workflow*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['dependencies', 'security', 'automated', 'maintenance']
              });
            }

  # Job 9: Security Scan Notification and Status
  security-notification:
    name: Security Scan Notification
    runs-on: ubuntu-latest
    needs:
      [
        security-setup,
        code-security,
        dependency-security,
        container-security,
        infrastructure-security,
        security-validation,
        security-report,
        create-security-issues,
      ]
    if: always()

    steps:
      - name: Download security summary
        uses: actions/download-artifact@v4
        with:
          name: comprehensive-security-report
        continue-on-error: true

      - name: Generate final status summary
        run: |
          echo "# üîí SynthaTrial Security Scan Complete" > final-status.md
          echo "" >> final-status.md
          echo "**Repository:** ${{ github.repository }}" >> final-status.md
          echo "**Scan Date:** $(date -u)" >> final-status.md
          echo "**Trigger:** ${{ github.event_name }}" >> final-status.md
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> final-status.md
          echo "" >> final-status.md

          echo "## üìä Job Results" >> final-status.md
          echo "- **Security Setup:** ${{ needs.security-setup.result }}" >> final-status.md
          echo "- **Code Security:** ${{ needs.code-security.result }}" >> final-status.md
          echo "- **Dependency Security:** ${{ needs.dependency-security.result }}" >> final-status.md
          echo "- **Container Security:** ${{ needs.container-security.result }}" >> final-status.md
          echo "- **Infrastructure Security:** ${{ needs.infrastructure-security.result }}" >> final-status.md
          echo "- **Security Validation:** ${{ needs.security-validation.result }}" >> final-status.md
          echo "- **Security Report:** ${{ needs.security-report.result }}" >> final-status.md
          echo "- **Issue Creation:** ${{ needs.create-security-issues.result }}" >> final-status.md
          echo "" >> final-status.md

          # Add security summary if available
          if [ -f security-summary.md ]; then
            echo "## üìã Security Summary" >> final-status.md
            cat security-summary.md >> final-status.md
          fi

          echo "" >> final-status.md
          echo "## üìÅ Available Artifacts" >> final-status.md
          echo "- \`comprehensive-security-report\` - Complete security analysis" >> final-status.md
          echo "- \`code-security-reports\` - Static code analysis results" >> final-status.md
          echo "- \`dependency-security-reports\` - Dependency vulnerability analysis" >> final-status.md
          echo "- \`container-security-reports-*\` - Container image security scans" >> final-status.md
          echo "- \`infrastructure-security-reports\` - Infrastructure configuration analysis" >> final-status.md
          echo "- \`security-validation-results\` - Threshold validation results" >> final-status.md

      - name: Check overall security status
        run: |
          echo "üîç Checking overall security scan status..."

          CRITICAL_JOBS_FAILED=0

          # Check critical job failures
          if [ "${{ needs.security-setup.result }}" = "failure" ]; then
            echo "‚ùå Security setup failed"
            CRITICAL_JOBS_FAILED=$((CRITICAL_JOBS_FAILED + 1))
          fi

          if [ "${{ needs.security-validation.result }}" = "failure" ]; then
            echo "‚ùå Security validation failed - vulnerabilities exceed threshold"
            CRITICAL_JOBS_FAILED=$((CRITICAL_JOBS_FAILED + 1))
          fi

          # Check if security passed validation
          if [ "${{ needs.security-validation.outputs.security_passed }}" = "false" ]; then
            echo "‚ùå Security validation failed - build should be blocked"
            CRITICAL_JOBS_FAILED=$((CRITICAL_JOBS_FAILED + 1))
          fi

          # Check if critical issues were found
          if [ "${{ needs.security-validation.outputs.critical_issues_found }}" = "true" ]; then
            echo "üö® Critical security issues found - immediate attention required"
          fi

          # Summary
          if [ $CRITICAL_JOBS_FAILED -gt 0 ]; then
            echo "‚ùå Security scan failed with $CRITICAL_JOBS_FAILED critical issues"
            echo "üö´ Build should be blocked until security issues are resolved"
            exit 1
          else
            echo "‚úÖ Security scan completed successfully"
            echo "üîí No critical security issues blocking the build"
            exit 0
          fi

      - name: Upload final status
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-final-status
          path: final-status.md
