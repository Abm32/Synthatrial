# Enhanced Development Docker Compose Configuration for SynthaTrial
# Provides comprehensive development environment with hot reload, debugging, and quality tools
# Version: 0.2 Beta

version: "3.8"

services:
  synthatrial-dev-enhanced:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev-enhanced
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: synthatrial:dev-enhanced
    container_name: synthatrial-dev-enhanced

    # Development environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app
      - DEVELOPMENT_MODE=1
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_ENABLE_CORS=false
      - STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=false
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
      - PINECONE_API_KEY=${PINECONE_API_KEY:-}
      - PINECONE_INDEX=${PINECONE_INDEX:-drug-index}

    # Port mappings for development services
    ports:
      - "8501:8501" # Streamlit web interface
      - "8888:8888" # Jupyter Lab
      - "8000:8000" # Additional development server
      - "3000:3000" # Node.js development server
      - "5000:5000" # Flask/FastAPI development server

    # Volume mappings for development
    volumes:
      # Source code (hot reload)
      - .:/app
      - /app/.pytest_cache
      - /app/.mypy_cache
      - /app/.hypothesis

      # Data directories (persistent)
      - ./data:/app/data
      - ./logs:/app/logs

      # Development artifacts (persistent)
      - dev_reports:/app/reports
      - dev_coverage:/app/coverage
      - dev_notebooks:/app/notebooks/development

      # Git configuration (for development)
      - ~/.gitconfig:/root/.gitconfig:ro
      - ~/.ssh:/root/.ssh:ro

      # Development tools cache
      - dev_cache:/root/.cache
      - dev_npm_cache:/root/.npm
      - dev_conda_cache:/opt/conda/pkgs

    # Development-specific networking
    networks:
      - synthatrial-dev

    # Health check for development environment
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits for development
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 8G
        reservations:
          cpus: "1.0"
          memory: 2G

    # Development command
    command: ["dev"]

    # Enable interactive terminal
    stdin_open: true
    tty: true

    # Development labels
    labels:
      - "traefik.enable=false"
      - "com.synthatrial.environment=development"
      - "com.synthatrial.version=0.2-beta"
      - "com.synthatrial.image=enhanced-dev"

  # Optional: Redis for development caching
  redis-dev:
    image: redis:7-alpine
    container_name: synthatrial-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis_dev_data:/data
    networks:
      - synthatrial-dev
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "com.synthatrial.service=cache"
      - "com.synthatrial.environment=development"

  # Optional: PostgreSQL for development database
  postgres-dev:
    image: postgres:15-alpine
    container_name: synthatrial-postgres-dev
    environment:
      - POSTGRES_DB=synthatrial_dev
      - POSTGRES_USER=dev_user
      - POSTGRES_PASSWORD=dev_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./scripts/sql:/docker-entrypoint-initdb.d
    networks:
      - synthatrial-dev
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev_user -d synthatrial_dev"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "com.synthatrial.service=database"
      - "com.synthatrial.environment=development"

  # Optional: Mailhog for development email testing
  mailhog-dev:
    image: mailhog/mailhog:latest
    container_name: synthatrial-mailhog-dev
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Web UI
    networks:
      - synthatrial-dev
    labels:
      - "com.synthatrial.service=mail"
      - "com.synthatrial.environment=development"

# Named volumes for development persistence
volumes:
  dev_reports:
    driver: local
    labels:
      - "com.synthatrial.volume=reports"
      - "com.synthatrial.environment=development"

  dev_coverage:
    driver: local
    labels:
      - "com.synthatrial.volume=coverage"
      - "com.synthatrial.environment=development"

  dev_notebooks:
    driver: local
    labels:
      - "com.synthatrial.volume=notebooks"
      - "com.synthatrial.environment=development"

  dev_cache:
    driver: local
    labels:
      - "com.synthatrial.volume=cache"
      - "com.synthatrial.environment=development"

  dev_npm_cache:
    driver: local
    labels:
      - "com.synthatrial.volume=npm-cache"
      - "com.synthatrial.environment=development"

  dev_conda_cache:
    driver: local
    labels:
      - "com.synthatrial.volume=conda-cache"
      - "com.synthatrial.environment=development"

  redis_dev_data:
    driver: local
    labels:
      - "com.synthatrial.volume=redis-data"
      - "com.synthatrial.environment=development"

  postgres_dev_data:
    driver: local
    labels:
      - "com.synthatrial.volume=postgres-data"
      - "com.synthatrial.environment=development"

# Development network
networks:
  synthatrial-dev:
    driver: bridge
    labels:
      - "com.synthatrial.network=development"
    ipam:
      config:
        - subnet: 172.20.0.0/16
